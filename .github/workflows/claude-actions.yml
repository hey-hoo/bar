name: Bar Claude Actions

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  claude-response:
    if: contains(github.event.issue.title, '@claude') || contains(github.event.issue.body, '@claude') || contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ github.token }}
        
    - name: Get request
      id: req
      run: |
        if [ "${{ github.event_name }}" = "issues" ]; then
          echo '${{ github.event.issue.body }}' > request.txt
        else
          echo '${{ github.event.comment.body }}' > request.txt
        fi
        echo "file=request.txt" >> $GITHUB_OUTPUT
        
    - name: Call Claude
      run: |
        REQUEST_FILE="${{ steps.req.outputs.file }}"
        REQUEST_CONTENT=$(cat "$REQUEST_FILE")
        
        # æ—¢å­˜ã®index.mdã®å†…å®¹ã‚’èª­ã¿å–ã‚Š
        if [ -f "index.md" ]; then
          EXISTING_CONTENT=$(cat index.md | sed '1,/^---$/d' | sed '1,/^---$/d')
        else
          EXISTING_CONTENT=""
        fi
        
        curl -s -X POST https://api.anthropic.com/v1/messages \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
          -H "anthropic-version: 2023-06-01" \
          -d "{
            \"model\": \"claude-3-sonnet-20240229\",
            \"max_tokens\": 2000,
            \"messages\": [{
              \"role\": \"user\", 
              \"content\": \"ã‚ãªãŸã¯ãƒãƒ¼ã®Webã‚µã‚¤ãƒˆç®¡ç†è€…ã§ã™ã€‚æ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚µã‚¤ãƒˆã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚\\n\\nã€é‡è¦ãªæ›´æ–°ãƒ«ãƒ¼ãƒ«ã€‘\\n1. æ—¢å­˜ã®å†…å®¹ã¯å¿…ãšä¿æŒã™ã‚‹\\n2. æ–°è¦æƒ…å ±ã®è¿½åŠ æ™‚ã¯å†’é ­ã«è¿½åŠ \\n3. ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ æ™‚ã¯è©²å½“ã‚«ãƒ†ã‚´ãƒªã«è¿½åŠ \\n4. å€¤æ®µå¤‰æ›´æ™‚ã¯è©²å½“å•†å“ã®ä¾¡æ ¼ã®ã¿å¤‰æ›´\\n5. å£²ã‚Šåˆ‡ã‚Œå•†å“ã¯å–ã‚Šæ¶ˆã—ç·šï¼ˆ~~å•†å“å~~ï¼‰ã«ã™ã‚‹\\n6. å…¨ä½“ã‚’æ›¸ãæ›ãˆãšã€æŒ‡ç¤ºã•ã‚ŒãŸå¤‰æ›´ã®ã¿å®Ÿè¡Œ\\n\\nã€ç¾åœ¨ã®Webã‚µã‚¤ãƒˆå†…å®¹ã€‘\\n$EXISTING_CONTENT\\n\\nã€æ›´æ–°æŒ‡ç¤ºã€‘\\n$REQUEST_CONTENT\\n\\nä¸Šè¨˜ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§æ›´æ–°å¾Œã®å®Œå…¨ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚æ—¢å­˜ã®æ§‹é€ ã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä¿æŒã—ã¦ãã ã•ã„ã€‚\"
            }]
          }" | jq -r '.content[0].text // "ã‚¨ãƒ©ãƒ¼: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ"' > content.txt
        
    - name: Update index
      run: |
        echo "---" > index.md
        echo "layout: home" >> index.md
        echo "---" >> index.md
        echo "" >> index.md
        cat content.txt >> index.md
        
    - name: Commit
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Bar Claude Actions"
        git fetch origin
        git rebase origin/main || git reset --hard origin/main
        echo "---" > index.md
        echo "layout: home" >> index.md
        echo "---" >> index.md
        echo "" >> index.md
        cat content.txt >> index.md
        git add .
        git commit -m "Update bar content via Claude" || echo "No changes"
        git push origin main
        
    - name: Comment
      run: |
        curl -X POST \
          -H "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
          -d '{"body":"ğŸ» ãƒãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼"}'
